services:
  god-mode:
    build: .
    container_name: god_mode_lab

    # --- HARDWARE ACCESS ---
    # NOTE: Docker-in-Docker REQUIRES privileged: true
    # Attempted to use minimal capabilities (SYS_ADMIN, NET_ADMIN) but failed because:
    # - DinD needs write access to /sys/fs/cgroup for container cgroup management
    # - Capabilities alone cannot grant this access (read-only mount)
    # - Error: "mkdir /sys/fs/cgroup/docker: read-only file system"
    # SECURITY TRADE-OFF: Accepting privileged mode as necessary for core functionality
    privileged: true

    # --- VISUAL BRIDGE ---
    # NOTE: Using bridge networking (default) for better security isolation
    # X11 communication uses Unix sockets (/tmp/.X11-unix), not network
    # network_mode: host removed - not needed for GUI functionality
    environment:
      - DISPLAY=${DISPLAY} # Automatically grabs your Host's screen ID (e.g., :1)

    # --- SECRETS MANAGEMENT ---
    env_file:
      - .env.secrets # Use .env.secrets for actual secrets

    # --- PERSISTENCE LAYER ---
    volumes:
      - ./workspace:/root/workspace
      # Map X11 sockets so the GUI can "talk" to the screen
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      # Note: .Xauthority mount disabled - not needed with xhost +local:root
      - $HOME/.Xauthority:/root/.Xauthority:rw

    # --- RESOURCE LIMITS ---
    deploy:
      resources:
        limits:
          cpus: '6.0'
          memory: 16G
        reservations:
          cpus: '2.0'
          memory: 4G
      # --- HEALTH CHECK ---
    healthcheck:
      test: [ "CMD", "docker", "version" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    restart: unless-stopped
